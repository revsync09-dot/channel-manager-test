<!DOCTYPE html>
<html lang="en" class="bg-black">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ brand_name }} - Overview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            500: '#8B5CF6',
                            600: '#7C3AED',
                            700: '#5B21B6',
                        }
                    }
                }
            }
        };
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body class="min-h-screen bg-slate-950 text-white flex">
    <!-- Sidebar with real command catalog -->
    <aside class="hidden lg:flex w-80 border-r border-white/5 flex-col bg-black/40">
        <div class="p-6 border-b border-white/5 flex items-center space-x-3">
            <div class="h-12 w-12 rounded-2xl bg-gradient-to-br from-brand-500 to-purple-500 grid place-items-center text-xl font-semibold">
                {{ brand_name.split()[0][0] if brand_name else 'CM' }}
            </div>
            <div>
                <p class="text-xs text-slate-400 uppercase tracking-widest">Cluster</p>
                <p class="text-lg font-semibold">{{ brand_name }}</p>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto scroll-section p-6 space-y-8">
            {% for section in nav_sections %}
                <div class="space-y-3">
                    <div>
                        <div class="flex items-center justify-between">
                            <p class="text-xs uppercase tracking-widest text-slate-400">{{ translations.sidebar.sections.get(section.title, section.title.replace('_',' ').title()) }}</p>
                        </div>
                        <p class="text-[13px] text-slate-500 mt-1">{{ translations.sidebar.descriptions.get(section.description, '') }}</p>
                    </div>
                    <ul class="space-y-1.5">
                        {% for item in section.items %}
                            <li class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 transition">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">{{ translations.sidebar.items.get(item.key, item.key.replace('_', ' ').title()) }}</span>
                                    <span class="text-[11px] text-slate-500">{{ item.key }}</span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
        </div>
        <div class="p-6 border-t border-white/5">
            <div class="rounded-2xl p-4 bg-white/5 border border-white/10 text-sm space-y-3">
                <p class="text-xs uppercase tracking-widest text-slate-400">Support</p>
                {% set dashboard_copy = translations.dashboard %}
                <p class="text-slate-300">{{ dashboard_copy.get('need_help', 'Need help? Jump into the bot support server.') }}</p>
                <a href="{{ support_invite }}" target="_blank" class="inline-flex justify-center items-center rounded-xl bg-gradient-to-r from-brand-500 to-indigo-500 py-2.5 font-semibold">
                    Support Channel
                </a>
            </div>
        </div>
    </aside>

    <!-- Main content -->
    <section class="flex-1 flex flex-col">
        <header class="p-6 border-b border-white/5 flex flex-wrap gap-4 justify-between items-center">
            <div>
                <p class="text-sm text-slate-400">{{ brand_name }} &bull; Overview{% if developer_mode %} &mdash; Developer Mode{% endif %}</p>
                <h1 class="text-3xl font-semibold">Dashboard Overview</h1>
                <p class="text-slate-400 text-sm mt-1">{{ tagline }}</p>
            </div>
            <div class="flex items-center gap-4">
                <form method="POST" action="{{ url_for('set_locale') }}" class="flex items-center">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <label class="sr-only" for="locale-select">Locale</label>
                    <select id="locale-select" name="locale" class="bg-transparent border border-white/10 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-brand-500" onchange="this.form.submit()">
                        {% for code in languages %}
                            <option value="{{ code }}" {% if code == active_locale %}selected{% endif %}>{{ code.upper() }}</option>
                        {% endfor %}
                    </select>
                </form>
                <a href="{{ support_invite }}" target="_blank" class="px-4 py-2 rounded-xl border border-white/10 hover:border-white/30 transition text-sm">Support</a>
                <form method="POST" action="{{ url_for('dashboard_command_request') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="command" value="/health">
                    <input type="hidden" name="guild_id" value="{{ guilds[0].id if guilds else '' }}">
                    <button type="submit" class="px-4 py-2 rounded-xl border border-white/10 hover:border-white/30 transition flex items-center gap-2 text-sm">
                        &#128260; Refresh
                    </button>
                </form>
                <div class="flex items-center gap-3">
                    <div class="text-right">
                        <p class="text-sm font-semibold">{{ user.global_name or user.username }}</p>
                        <p class="text-xs text-slate-400">{{ bot_status.version }}</p>
                    </div>
                    <div class="relative">
                        <img src="{{ avatar_url }}" alt="Profile" class="h-12 w-12 rounded-2xl border border-white/10">
                        <span class="absolute -bottom-1 -right-1 w-3 h-3 rounded-full bg-emerald-400 status-dot"></span>
                    </div>
                </div>
            </div>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="px-6 pt-4 space-y-2">
                    {% for category, message in messages %}
                        <div class="rounded-2xl px-4 py-3 text-sm {% if category == 'error' %}bg-red-500/10 text-red-200 border border-red-500/30{% else %}bg-emerald-500/10 text-emerald-200 border border-emerald-500/30{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <main class="flex-1 overflow-y-auto scroll-section p-6 space-y-8">
            <!-- Overview cards -->
            <section class="grid gap-4 grid-cols-1 md:grid-cols-2 xl:grid-cols-4">
                {% for card in overview_cards %}
                    <div class="rounded-2xl border border-white/5 bg-gradient-to-br from-white/5 to-white/0 p-5">
                        <p class="text-sm text-slate-400 mb-2">{{ card.label }}</p>
                        <p class="text-3xl font-semibold">{{ card.value }}</p>
                        <p class="text-xs text-emerald-400 mt-3">{{ card.delta }}</p>
                    </div>
                {% endfor %}
            </section>

            <!-- Live statistics auto-refresh section -->
            <section class="grid gap-4 grid-cols-1 md:grid-cols-2 xl:grid-cols-3">
                <div class="rounded-2xl border border-white/5 bg-black/30 p-5">
                    <p class="text-sm text-slate-400">Guild Count</p>
                    <p class="text-3xl font-semibold" id="live-guilds">--</p>
                </div>
                <div class="rounded-2xl border border-white/5 bg-black/30 p-5">
                    <p class="text-sm text-slate-400">User Count</p>
                    <p class="text-3xl font-semibold" id="live-users">--</p>
                </div>
                <div class="rounded-2xl border border-white/5 bg-black/30 p-5">
                    <p class="text-sm text-slate-400">Commands Run</p>
                    <p class="text-3xl font-semibold" id="live-commands">--</p>
                </div>
                <div class="rounded-2xl border border-white/5 bg-black/30 p-5">
                    <p class="text-sm text-slate-400">Latency</p>
                    <p class="text-3xl font-semibold" id="live-latency">--</p>
                </div>
                <div class="rounded-2xl border border-white/5 bg-black/30 p-5">
                    <p class="text-sm text-slate-400">Uptime</p>
                    <p class="text-3xl font-semibold" id="live-uptime">--</p>
                </div>
                <div class="rounded-2xl border border-white/5 bg-black/30 p-5">
                    <p class="text-sm text-slate-400">CPU / RAM</p>
                    <p class="text-3xl font-semibold"><span id="live-cpu">--</span>% / <span id="live-ram">--</span>%</p>
                </div>
            </section>

            <!-- Activity + summaries -->
            <section class="grid gap-6 xl:grid-cols-3">
                <div class="rounded-2xl border border-white/5 p-6 bg-black/20 xl:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-sm text-slate-400">Live data from user_activity table</p>
                            <h2 class="text-2xl font-semibold">Community Activity</h2>
                        </div>
                        <span class="px-3 py-1 rounded-full bg-emerald-400/20 text-emerald-300 text-sm">
                            {{ metrics.activity_today.chat + metrics.activity_today.voice if metrics else 0 }} min today
                        </span>
                    </div>
                    <div class="flex items-end gap-2 h-56">
                        {% set max_value = activity_max or 1 %}
                        {% for point in activity_series %}
                            {% set height = (point.value / max_value) * 100 %}
                            <div class="flex flex-col items-center flex-1">
                                <div class="w-5 rounded-full bg-gradient-to-t from-brand-500 to-purple-400" style="height: {{ height if height > 6 else 6 }}%">
                                </div>
                                <span class="text-[10px] text-slate-500 mt-2">{{ point.label }}</span>
                            </div>
                        {% else %}
                            <p class="text-slate-400 text-sm">No recent activity recorded.</p>
                        {% endfor %}
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="rounded-2xl border border-white/5 p-6">
                        <h2 class="text-xl font-semibold mb-4">Command Summary</h2>
                        <div class="space-y-3">
                            {% for group in command_groups %}
                                <div class="flex items-center justify-between text-sm text-slate-300">
                                    <span>{{ group.name }}</span>
                                    <span class="px-2 py-0.5 rounded-full bg-white/5 text-xs">{{ group.commands|length }} commands</span>
                                </div>
                            {% endfor %}
                        </div>
                        <p class="text-xs text-slate-400 mt-4">{{ command_total }} slash commands total.</p>
                    </div>
                    <div class="rounded-2xl border border-white/5 p-6 bg-white/5">
                        <h2 class="text-xl font-semibold mb-3">Bot Status</h2>
                        <ul class="text-sm space-y-2 text-slate-300">
                            <li class="flex justify-between"><span>Cluster</span><span>{{ bot_status.cluster }}</span></li>
                            <li class="flex justify-between"><span>Region</span><span>{{ bot_status.region }}</span></li>
                            <li class="flex justify-between"><span>Latency</span><span>{{ bot_status.latency }}</span></li>
                            <li class="flex justify-between"><span>Uptime</span><span>{{ bot_status.uptime }}</span></li>
                            <li class="flex justify-between"><span>Refreshed</span><span>{{ bot_status.refreshed }}</span></li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Recent servers and owner logs -->
            <section class="grid gap-6 lg:grid-cols-2">
                <div class="rounded-2xl border border-white/5 p-6 bg-black/20">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-sm text-slate-400">{{ recent_servers|length }} guilds displayed</p>
                            <h2 class="text-2xl font-semibold">Recent Server Joins</h2>
                        </div>
                        <span class="px-3 py-1 rounded-full bg-white/5 text-xs text-slate-300">Live</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="text-slate-400 uppercase text-xs tracking-widest">
                                    <th class="py-2">Server Name</th>
                                    <th class="py-2">Members</th>
                                    <th class="py-2">Region</th>
                                    <th class="py-2">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5">
                                {% for server in recent_servers %}
                                    <tr class="py-3">
                                        <td class="py-3">
                                            <div class="flex items-center gap-3">
                                                <div class="h-9 w-9 rounded-full bg-white/5 grid place-items-center text-xs uppercase">
                                                    {{ server.name[:2] if server.name else 'SV' }}
                                                </div>
                                                <span>{{ server.name }}</span>
                                            </div>
                                        </td>
                                        <td class="py-3 text-slate-300">{{ server.members }}</td>
                                        <td class="py-3 text-slate-300">{{ server.region }}</td>
                                        <td class="py-3">
                                            <span class="px-3 py-1 rounded-full text-xs bg-emerald-500/10 text-emerald-300">{{ server.status }}</span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="rounded-2xl border border-white/5 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold">Owner Logging</h2>
                        <span class="text-xs text-slate-400 uppercase tracking-widest">Root Access</span>
                    </div>
                    <ul class="space-y-4">
                        {% for log in owner_logs %}
                            <li class="p-4 rounded-xl bg-white/5 flex items-center justify-between">
                                <div>
                                    <p class="font-semibold">{{ log.title }}</p>
                                    <p class="text-sm text-slate-400">{{ log.detail }}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs px-3 py-1 rounded-full bg-white/10 text-white/70">{{ log.status }}</span>
                                    <p class="text-xs text-slate-400 mt-2">{{ log.timestamp }}</p>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </section>

            {% if module_cards and guilds %}
            <section class="space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-semibold">Modules</h2>
                    <p class="text-sm text-slate-400">Manage each feature per guild.</p>
                </div>
                <div class="grid gap-4 md:grid-cols-2">
                    {% for module in module_cards %}
                        <div class="rounded-2xl border border-white/10 p-4 bg-white/5 flex flex-col justify-between">
                            <div>
                                <h3 class="font-semibold">{{ module.title }}</h3>
                                <p class="text-sm text-slate-400">{{ module.description }}</p>
                            </div>
                            <div class="mt-4">
                                {% if guilds %}
                                    <a href="{{ url_for('module_dashboard_view', guild_id=guilds[0].id, module_slug=module.slug) }}" class="inline-flex items-center px-3 py-2 rounded-xl bg-gradient-to-r from-brand-500 to-indigo-500 font-semibold text-sm">
                                        Open for {{ guilds[0].name }}
                                    </a>
                                {% else %}
                                    <p class="text-xs text-slate-500">Add the bot to a guild to manage this module.</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- Command launcher + library -->
            <section class="grid gap-6 xl:grid-cols-3">
                <div class="rounded-2xl border border-white/5 p-6 bg-black/30">
                    <h2 class="text-2xl font-semibold mb-2">Command Launcher</h2>
                    <p class="text-sm text-slate-400 mb-4">Queue slash commands directly from the dashboard. The bot reads the pending list and executes them inside the selected guild.</p>
                    <form method="POST" action="{{ url_for('dashboard_command_request') }}" class="space-y-4">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <div>
                            <label class="text-xs uppercase tracking-widest text-slate-400">Command</label>
                            <select name="command" class="w-full mt-1 bg-transparent border border-white/10 rounded-xl px-3 py-2 text-sm focus:border-brand-500 focus:outline-none">
                                {% for group in command_groups %}
                                    <optgroup label="{{ group.name }}">
                                        {% for command in group.commands %}
                                            <option value="{{ command.name }}">{{ command.name }} - {{ command.description }}</option>
                                        {% endfor %}
                                    </optgroup>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="text-xs uppercase tracking-widest text-slate-400">Guild</label>
                            <select name="guild_id" class="w-full mt-1 bg-transparent border border-white/10 rounded-xl px-3 py-2 text-sm focus:border-brand-500 focus:outline-none">
                                {% for guild in admin_guilds %}
                                    <option value="{{ guild.id }}">{{ guild.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="text-xs uppercase tracking-widest text-slate-400">Payload / Notes</label>
                            <textarea name="payload" rows="4" class="w-full mt-1 bg-transparent border border-white/10 rounded-2xl px-3 py-2 text-sm focus:border-brand-500 focus:outline-none" placeholder='Optional JSON or notes (e.g. {&quot;channel&quot;: &quot;123&quot;})'></textarea>
                        </div>
                        <button type="submit" class="w-full rounded-2xl bg-gradient-to-r from-brand-500 to-indigo-500 py-2.5 font-semibold">Queue Command</button>
                    </form>
                </div>
                <div class="xl:col-span-2 rounded-2xl border border-white/5 p-6 grid gap-4">
                    <h2 class="text-2xl font-semibold">Command Library</h2>
                    <p class="text-sm text-slate-400 mb-4">All slash commands grouped by module. Use the launcher on the left or copy descriptions for your team.</p>
                    <div class="grid gap-4 md:grid-cols-2">
                        {% for group in command_groups %}
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 space-y-3">
                                <div class="flex items-center justify-between">
                                    <h3 class="font-semibold">{{ group.name }}</h3>
                                    <span class="text-[10px] uppercase tracking-widest text-white/70">{{ group.badge }}</span>
                                </div>
                                <p class="text-sm text-slate-400">{{ group.description }}</p>
                                <ul class="space-y-2">
                                    {% for command in group.commands %}
                                        <li class="p-3 rounded-xl bg-black/20 border border-white/5">
                                            <div class="flex items-center justify-between text-sm">
                                                <span class="font-semibold">{{ command.name }}</span>
                                                <span class="text-[11px] text-slate-400">{{ command.permissions }}</span>
                                            </div>
                                            <p class="text-xs text-slate-400 mt-1">{{ command.description }}</p>
                                            {% if command.supports_modal %}
                                                <span class="text-[10px] uppercase tracking-widest text-emerald-400">Modal supported</span>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </section>
        </main>
    </section>
    <script>
        async function refreshLiveStats() {
            try {
                const response = await fetch('{{ url_for("api_live_bot") }}');
                if (!response.ok) return;
                const data = await response.json();
                const setText = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };
                const fmt = (value) => typeof value === 'number' ? value.toFixed(1) : value ?? '--';
                setText('live-guilds', data.guild_count ?? '--');
                setText('live-users', data.user_count ?? '--');
                setText('live-commands', data.total_commands_run ?? '--');
                setText('live-latency', data.latency_ms ? data.latency_ms + 'ms' : '--');
                setText('live-uptime', data.uptime ?? '--');
                setText('live-cpu', fmt(data.cpu_usage));
                setText('live-ram', fmt(data.ram_usage));
            } catch (err) {
                console.error('Failed to refresh live stats', err);
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            refreshLiveStats();
            setInterval(refreshLiveStats, 10000);
        });
    </script>
</body>
</html>
