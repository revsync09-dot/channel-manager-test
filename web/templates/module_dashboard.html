<!DOCTYPE html>
<html lang="en" class="bg-black">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ module.title }} - {{ guild.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            500: '#8B5CF6',
                            600: '#7C3AED',
                            700: '#5B21B6',
                        }
                    }
                }
            }
        };
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body class="min-h-screen bg-slate-950 text-white p-6 space-y-8">
    <header class="glass-panel rounded-3xl p-8 flex flex-wrap gap-6 justify-between">
        <div>
            <p class="text-sm text-slate-400 uppercase tracking-widest mb-2">{{ module.title }}</p>
            <h1 class="text-3xl font-semibold mb-2">{{ guild.name }}</h1>
            <p class="text-slate-400">{{ module.description }}</p>
        </div>
        <div class="flex items-center gap-4">
            <a href="{{ url_for('dashboard') }}" class="px-4 py-2 rounded-xl border border-white/10 hover:border-white/30 transition text-sm">Back to Dashboard</a>
            <img src="{{ avatar_url if avatar_url else url_for('static', filename='assets/logo.png') }}" alt="Avatar" class="h-14 w-14 rounded-2xl border border-white/10">
        </div>
    </header>

    <section class="grid gap-6 lg:grid-cols-2">
        <div class="rounded-3xl border border-white/10 p-6 bg-black/40">
            <h2 class="text-xl font-semibold mb-3">Summary</h2>
            <pre class="text-sm bg-black/50 border border-white/10 rounded-2xl p-4 overflow-x-auto">{{ summary | tojson(indent=2) }}</pre>
        </div>
        <div class="rounded-3xl border border-white/10 p-6 bg-black/40 space-y-4">
            <h2 class="text-xl font-semibold">Actions</h2>
            {% if module.actions %}
                {% for action in module.actions %}
                    <form class="module-action-form space-y-3 border border-white/10 rounded-2xl p-4" data-endpoint="{{ url_for('api_module', guild_id=guild.id, module_slug=module_slug) }}" data-action="{{ action.name }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <p class="font-semibold">{{ action.label }}</p>
                        {% for field in action.fields %}
                            <div class="text-sm">
                                <label class="block text-slate-400 uppercase tracking-widest text-[11px] mb-1">{{ field.label }}</label>
                                {% if field.type == 'textarea' %}
                                    <textarea name="{{ field.name }}" rows="3" class="w-full bg-transparent border border-white/10 rounded-2xl px-3 py-2 focus:border-brand-500 focus:outline-none"></textarea>
                                {% else %}
                                    <input name="{{ field.name }}" type="{{ field.type }}" class="w-full bg-transparent border border-white/10 rounded-xl px-3 py-2 focus:border-brand-500 focus:outline-none">
                                {% endif %}
                            </div>
                        {% endfor %}
                        <button type="submit" class="w-full rounded-xl bg-gradient-to-r from-brand-500 to-indigo-500 py-2 font-semibold text-sm">Execute</button>
                    </form>
                {% endfor %}
            {% else %}
                <p class="text-sm text-slate-400">This module is read-only.</p>
            {% endif %}
            <div id="module-action-result" class="text-sm text-emerald-300"></div>
        </div>
    </section>

    <script>
        const MODULE_CSRF_TOKEN = '{{ csrf_token }}';
        document.querySelectorAll('.module-action-form').forEach((form) => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const endpoint = form.dataset.endpoint;
                const action = form.dataset.action;
                const formData = new FormData(form);
                const payload = { action };
                formData.forEach((value, key) => {
                    if (payload[key]) return;
                    payload[key] = value;
                });
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': MODULE_CSRF_TOKEN,
                        },
                        body: JSON.stringify(payload),
                    });
                    const data = await response.json();
                    const resultEl = document.getElementById('module-action-result');
                    if (response.ok) {
                        resultEl.textContent = JSON.stringify(data.result || data, null, 2);
                        resultEl.classList.remove('text-red-300');
                        resultEl.classList.add('text-emerald-300');
                    } else {
                        resultEl.textContent = data.error || 'Action failed';
                        resultEl.classList.remove('text-emerald-300');
                        resultEl.classList.add('text-red-300');
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        });
    </script>
</body>
</html>
